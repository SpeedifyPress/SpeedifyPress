(function(){class CSSUsageCollector{constructor(e=!0,t=[]){this.cacheDir="undefined"!=typeof speed_css_vars&&speed_css_vars.cache_directory?speed_css_vars.cache_directory:"acd-speedifypress",this.stylesheetsCSS={},this.currentHost=window.location.host,this.logWarnings=e,this.includePatterns=t,this.totalOriginalLength=0,this.totalFilteredLength=0,this.has_collected=!1,this.observedClasses=new Set,this.initialClassesMap=new Map,this.foundFamilies=new Set,this.usedFontRules=new Set,this.usedKeyframes=new Set,this.debug_selector="",this.debug=!1}async collect(){this.debug&&console.log("Start collect"),"function"==typeof window.unused_css_restoreTemplateContent&&window.unused_css_restoreTemplateContent(),this.has_collected=!0,this.observedClasses.forEach((e=>{this.includePatterns.push(new RegExp(`\\.${e}(\\.|s|,|{)`))})),window.spress_includePatterns=this.includePatterns;for(let n of document.styleSheets)this.shouldProcessSheet(n)&&(this.debug&&console.log("Processing fonts for sheet",n),await this.processFonts(n));for(let n of document.styleSheets)this.shouldProcessSheet(n)&&(this.debug&&console.log("Processing sheet",n),await this.processSheet(n));const e=this.getResults();if(this.debug&&console.log("Got results",e),Object.keys(e).length>0){var t=document.body.className.split(/\s+/),s=/^(rtl|home|blog|privacy-policy|archive|date|search(-[a-zA-Z0-9-_]+)?|paged|attachment|error404|[a-zA-Z0-9-__]+-template|single(-[a-zA-Z0-9-_]+)?|page(-[a-zA-Z0-9-_]+)?|post-type-archive(-[a-zA-Z0-9-_]+)?|author(-[a-zA-Z0-9-_]+)?|category(-[a-zA-Z0-9-_]+)?|tag(-[a-zA-Z0-9-_]+)?|tax(-[a-zA-Z0-9-_]+)?|term(-[a-zA-Z0-9-_]+)?)$/,o=t.filter((function(e){return s.test(e)}));this.debug&&console.log("Set vars 1");var r=this.getAllInvisibleElements();this.debug&&console.log("Got invisible element"),await this.getLcpImage().then((t=>{var s;this.updateConfig({css:e,url:document.location.href,post_id:(null==(s=document.body.className.split(" ").find((e=>e.startsWith("postid-")||e.startsWith("page-id-"))))?void 0:s.replace(/(postid-|page-id-)/,""))||null,post_types:o,invisible:{elements:r,viewport:{width:window.innerWidth,height:window.innerHeight}},usedFontRules:[...this.getFontsDownloaded()].join("|"),lcp_image:t,reduction:this.calculatePercentageDifference()})}))}return this.stylesheetsCSS}async processFonts(e){var t,s,o,r,n,l,i;try{if(!e.cssRules)return void this.warn(`Stylesheet '${e.href}' has no cssRules.`);this.debug&&/fusion-styles/.test(e.href)&&console.log("Sheet length:",e.cssRules.length);for(let c=0;c<e.cssRules.length;c++){const a=e.cssRules[c];if(this.debug&&/fusion-styles/.test(e.href),a.type===CSSRule.STYLE_RULE){if(this.shouldIncludeSelector(a.selectorText)||this.doesSelectorMatch(a)){const e=null==(s=null==(t=a.style)?void 0:t.getPropertyValue("font-family"))?void 0:s.trim();if(!e){const t=null==(r=null==(o=a.style)?void 0:o.getPropertyValue("font"))?void 0:r.trim();t&&(e=t.split("/").pop().split(" ").pop())}if(this.debug,e)if(e.startsWith("var(")){const t=e=>{var s;const o=document.querySelector(a.selectorText);if(!o)return null;const r=getComputedStyle(o).getPropertyValue(e).trim();if(r.startsWith("var(")){const e=null==(s=r.match(/var\((--[^)]+)\)/))?void 0:s[1];if(e)return t(e)}return r},s=null==(n=e.match(/var\((--[^)]+)\)/))?void 0:n[1];if(s){const e=t(s);e&&e.split(",").forEach((e=>{const t=e.trim().replace(/^["']|["']$/g,"");this.foundFamilies.add(t)}))}}else e.split(",").forEach((e=>{const t=e.trim().replace(/^["']|["']$/g,"");this.foundFamilies.add(t)}))}const e=null==(i=null==(l=a.style)?void 0:l.getPropertyValue("animation-name"))?void 0:i.trim();e&&"none"!==e&&this.usedKeyframes.add(e)}}}catch(c){this.warn(`Error processing stylesheet '${e.href}':`,c)}this.debug&&console.log("Found families:",this.foundFamilies)}async processSheet(e){var t,s;let o="";try{for(let n of e.cssRules)if(n.type===CSSRule.IMPORT_RULE){const e=n.styleSheet;e&&await this.processSheet(e)}else if(n.type===CSSRule.MEDIA_RULE){let e="";for(let t of n.cssRules)if(t.type===CSSRule.STYLE_RULE&&(this.shouldIncludeSelector(t.selectorText)||this.doesSelectorMatch(t))){e+=`  ${this.reconstructRule(t)}\n`}e.trim()&&(o+=`@media ${n.media.mediaText} {\n${e}}\n`)}else if(n.type===CSSRule.KEYFRAMES_RULE){let e="";if(this.usedKeyframes.has(n.name)){for(let t of n.cssRules)t.type===CSSRule.KEYFRAME_RULE&&(e+=`  ${t.keyText} { ${t.style.cssText} }\n`);e.trim()&&(o+=`@keyframes ${n.name} {\n${e}}\n`)}}else if(n.type===CSSRule.FONT_FACE_RULE){const r=null==(s=null==(t=n.style)?void 0:t.getPropertyValue("font-family"))?void 0:s.trim().replace(/['"]/g,"");if(r){const t=r.split(",").map((e=>e.trim()));this.debug&&/fusion-styles/.test(e.href)&&console.log("Families:",t);if(t.some((e=>this.foundFamilies.has(e)))&&(o+=n.cssText+"\n",!/data:/.test(n.cssText))){const t=n.style.getPropertyValue("src");if(t){const s=e.href?new URL(e.href,document.baseURI).href:document.baseURI,o=t.match(/url\(["']?(.+?)["']?\)/);if(o&&o[1]){const e=o[1],t=new URL(e,s).href;this.usedFontRules.add(t)}}}}}else if(n.selectorText)try{if(this.totalOriginalLength+=n.cssText.length,this.shouldIncludeSelector(n.selectorText)||this.doesSelectorMatch(n)){const e=this.reconstructRule(n);o+=e+"\n",this.totalFilteredLength+=e.length,this.debug_selector&&new RegExp(this.debug_selector).test(n.selectorText)&&(console.log("Selector matches debug_selector:",n.selectorText),console.log("Should include selector:",this.shouldIncludeSelector(n.selectorText)),console.log("Does selector match:",this.doesSelectorMatch(n,!0)))}}catch(r){this.warn(`Error testing selector '${n.selectorText}':`,r)}}catch(r){this.warn(`Error processing stylesheet '${e.href}':`,r)}e.href&&(this.stylesheetsCSS[e.href]=(this.stylesheetsCSS[e.href]||"")+o)}shouldProcessSheet(e){if(!e.href)return this.debug&&console.log("No href for",e),!1;try{const t=new URL(e.href);this.debug&&console.log("Sheet URL is",t);const s="string"==typeof e.ownerNode.dataset.spressProcessed&&"true"==e.ownerNode.dataset.spressProcessed;return t.host===this.currentHost&&!t.pathname.includes(this.cacheDir)&&!s}catch(t){return this.warn(`Error processing stylesheet '${e.href}':`,t),!1}}reconstructRule(e){let t=e.cssText;const s=e.style;for(let o=0;o<s.length;o++){const e=s[o];if("content"===e){let o=s.getPropertyValue(e),r=this.reEscapeContent(o);t=t.replace(`content: ${o}`,`content: ${r}`)}}return t}reEscapeContent(e){return e.replace(/[\uE000-\uF8FF]/g,(function(e){return"\\"+e.charCodeAt(0).toString(16).padStart(4,"0")}))}doesSelectorMatch(e,t){const s=e.selectorText;try{if(":root"===s.trim())return!0;if(!this.isValidSelector(s))return this.warn(`Invalid selector: '${s}'`),!1;var o=s.replace(/\s:not/,"*:not").replace(/:not\([^)]+\)/g,"").replace(/,\s*$/,"");const e=(o=o.replace(/:(hover|active|focus|visited|focus-within|focus-visible)/g,"")).replace(/::?(before|after|first-line|first-letter|marker|backdrop|placeholder|selection|spelling-error|grammar-error)/g,""),r=/::?[\w-]+/.test(o);t&&console.log(s,"CLEANED",o,"SEP",e,"COUNT",document.querySelectorAll(e).length);const n=document.querySelectorAll(e);if(0===n.length)return!1;if(!r)return!0;const l=Array.from(o.matchAll(/::?[\w-]+/g)).map((e=>e[0]));for(const t of n)for(const e of l){const s=window.getComputedStyle(t,e);if("none"!==s.content&&"none"!==s.display)return!0}const i=s.split(",");for(let t of i){if(document.querySelectorAll(t).length>0)return!0}return!1}catch(r){return this.warn(`Error querying selector '${s}':`,r),!1}}shouldIncludeSelector(e){return this.includePatterns.some((t=>t.test(e)))}isValidSelector(e){try{return document.createElement("div").querySelector(e),!0}catch(t){return!1}}updateConfig(e){this.debug&&console.log("Update config with ",e),(async()=>{try{const t=JSON.stringify(e),s=await this.compressAndBase64Encode(t);if(0==s)return void console.warn("Unable to update CSS on this browser");const o=await fetch("/wp-json/speedifypress/update_css",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({compressedData:s})}),r=await o.json();console.log("Successfully updated CSS:",r)}catch(t){console.log("Error updating config:",t)}})()}getFontsDownloaded(){if(!1 in performance)return new Set;const e=new Set,t=(e,t)=>{try{return new URL(e,t).href}catch(s){return e}};for(const r of document.styleSheets)try{const s=r.href||document.baseURI;for(const o of r.cssRules)if(o.type===CSSRule.FONT_FACE_RULE){const r=o.style.getPropertyValue("src");if(r){const o=r.match(/url\(([^)]+)\)/g);o&&o.forEach((o=>{const r=o.replace(/url\(|\)|'|"/g,"").trim(),n=t(r,s);e.add(n)}))}}}catch(o){}const s=new Set;return performance.getEntriesByType("resource").forEach((o=>{const r=t(o.name,document.baseURI);e.has(r)&&s.add(o.name)})),s}getLcpImage(){return new Promise((e=>{if(!("PerformanceObserver"in window)||!PerformanceObserver.supportedEntryTypes.includes("largest-contentful-paint"))return void e("");let t=null;const s=new PerformanceObserver((o=>{for(const e of o.getEntries())e.element&&"IMG"===e.element.tagName&&(t=e.element.src);t&&(e(t),s.disconnect())}));s.observe({type:"largest-contentful-paint",buffered:!0}),setTimeout((()=>{s.disconnect(),t||e("")}),500)}))}getResults(){return this.stylesheetsCSS}warn(...e){this.logWarnings&&console.warn(...e)}calculatePercentageDifference(){if(0===this.totalOriginalLength)return 0;return(this.totalOriginalLength-this.totalFilteredLength)/this.totalOriginalLength*100}async compressAndBase64Encode(e){try{const t=(new TextEncoder).encode(e),s=new Blob([t]).stream(),o=s.pipeThrough(new CompressionStream("gzip")).getReader(),r=[];let n,l;for(;({done:n,value:l}=await o.read()),!n;)r.push(l);const i=this.concatUint8Arrays(r);let c="";for(let e=0;e<i.length;e++)c+=String.fromCharCode(i[e]);return btoa(c)}catch(t){return!1}}concatUint8Arrays(e){let t=e.reduce(((e,t)=>e+t.length),0),s=new Uint8Array(t),o=0;for(let r of e)s.set(r,o),o+=r.length;return s}getAllInvisibleElements(e=document.body){const t=[];return function e(s){if(s!==document.body){const e=function(e){let t=0,s=0,o=e;for(;o;)t+=o.offsetLeft-o.scrollLeft+(parseFloat(window.getComputedStyle(o).borderLeftWidth)||0),s+=o.offsetTop-o.scrollTop+(parseFloat(window.getComputedStyle(o).borderTopWidth)||0),o=o.offsetParent;return{x:t,y:s}}(s),o=window.getComputedStyle(s),r=s.offsetWidth>0&&s.offsetHeight>0,n=0,l=1366,i=e.y,c=i+s.offsetHeight;e.x;s.offsetWidth;const a=c<=n||i>=l,h="fixed"===o.position||"sticky"===o.position,d="hidden"===o.visibility||"0"===o.opacity||"none"===o.display||"rect(1px, 1px, 1px, 1px)"===o.clip||"inset(50%)"===o.clipPath||parseFloat(o.width)<=1&&parseFloat(o.height)<=1||"hidden"===o.overflow&&parseFloat(o.height)<=1;if(a&&r&&!d&&!h)return void t.push({spuid:s.dataset.spuid})}for(let t of s.children)e(t)}(e),t}observe_contain(){}recordInitialClasses(){document.querySelectorAll("*").forEach((e=>{this.initialClassesMap.set(e,new Set(e.classList))}))}start_collect_added_classes(){this.recordInitialClasses();new MutationObserver((e=>{for(const t of e)if("attributes"===t.type&&"class"===t.attributeName){const e=t.target,s=this.initialClassesMap.get(e)||new Set;e.classList.forEach((e=>{s.has(e)||this.observedClasses.has(e)||this.observedClasses.add(e)}))}})).observe(document.body,{attributes:!0,subtree:!0})}collect_after_scroll(e=!1){e&&(this.debug=!0),this.observe_contain(),this.start_collect_added_classes(),this.scrollListener=()=>{clearTimeout(window.scrollIdleTimeout),window.scrollIdleTimeout=setTimeout((()=>{this.debug&&console.log("Collecting after scroll"),this.collect_when_idle()}),1e3)},window.addEventListener("scroll",this.scrollListener)}flash_scroll(){const e=window.scrollY;window.scrollTo({top:0,behavior:"instant"}),window.scrollTo({top:document.documentElement.scrollHeight,behavior:"instant"}),window.dispatchEvent(new Event("scroll")),window.scrollTo({top:e,behavior:"instant"})}collect_when_idle(){void 0!==this.scrollListener&&window.removeEventListener("scroll",this.scrollListener),requestIdleCallback((()=>{0==this.has_collected&&(this.debug&&console.log("Collecting after idle"),this.flash_scroll(),this.collect())}))}}!function(){let e=speed_css_vars.generation_res;const t=window.innerWidth;let s;if(s=t<=768?"mobile":t>768&&t<=1024?"tablet":"desktop","true"===e[s]){var o=JSON.parse(speed_css_vars.include_patterns);o=o.map((e=>new RegExp(e.replace(/\\\\/g,"\\"))));new CSSUsageCollector(!1,o).collect_after_scroll(!1)}}();})();